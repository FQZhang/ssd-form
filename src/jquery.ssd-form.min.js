/*
 * ssdForm jQuery plugin
 * Examples and documentation at: https://github.com/sebastiansulinski/ssd-form
 * Copyright (c) 2016 Sebastian Sulinski
 * Version: 1.3.1 (04-APR-2016)
 * Licensed under the MIT.
 * Requires: jQuery v1.9 or later
 */
!function(e,t,n){"use strict";t.fn.ssdForm=function(i){var a=t.extend({dataFormWrapper:"data-form-wrapper",dataConfirmation:"data-confirmation",dataValidationSegment:"data-validation",dataValidationCase:"data-case",dataSubmitTrigger:"data-submit-trigger",dataSubmitPending:"data-submit-pending",classHide:"hide",classShow:"show",extendBehaviours:{},extendValidationRules:{},ignoreElements:".button, [disabled]",serializeAttribute:null,actionMethod:function(e,n,i,a){t.ajax({method:n.method(),url:n.action(),data:n.data(),dataType:"json",cache:!1,success:i,error:a})}},i),r="["+a.dataFormWrapper+"]",s="["+a.dataConfirmation+"]",o="["+a.dataValidationSegment+"]",u="["+a.dataValidationCase+"]",c="["+a.dataSubmitTrigger+"]",d="["+a.dataSubmitPending+"]",l=function(){var e={};this.add=function(t,n){return e.hasOwnProperty(t)?!1:void(e[t]=n)},this.all=function(){return e},this.empty=function(){return 0===Object.keys(e).length}},f={replace:function(e){e.replace!==n&&t.each(e.replace,function(e,n){t("[data-"+e+"]").html(n)})},remove:function(e){e.remove!==n&&t.each(e.remove,function(e,n){t("[data-"+n+"]").remove()})},reload:function(){e.location.reload(!0)},redirect:function(t){e.location.href=t}},h=t.extend({elements:[],required:function(e){return!(""===e.value||null===e.value||e.value===n)},checked:function(e){return e.isChecked},value_is:function(e){return e.value==e.rules_collection},email:function(e){var t=/^[a-zA-Z0-9._\-]+@[a-zA-Z0-9]+([.\-]?[a-zA-Z0-9]+)?([\.]{1}[a-zA-Z]{2,4}){1,4}$/;return t.test(e.value)},password:function(e){var t=/(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{6,}/;return t.test(e.value)},min:function(e){return e.value.length>=e.rules_collection},max:function(e){return e.value.length<=e.rules_collection},confirmed:function(e){var t=e.name+"_confirmation",n=this.elements.filter(function(e,n){return n.name===t})[0];if(0===n.length)throw new Error(e.name+"_confirmation field is missing");return n.value===e.value},test:function(e,n){var i=this,a=t.Deferred();return i.elements=e,t.each(n.rules,function(e,t){var r=t.split(":"),s=r.shift();n.rules_collection=r,i[s](n)||a.reject(s),e+1==n.rules.length&&a.resolve()}),a.promise()}},a.extendValidationRules),m=function(e,i){function r(e){return e.isVisible||e.isEditor}function s(e,n){return-1===t.inArray("required",n.rules)&&""==n.value?!0:h.test(e,n)}function o(e,t,n){e+1===t&&(i.empty()?n.resolve():n.reject(i.all()))}if(!(e instanceof p))throw new Error("Invalid argument form_model.");if(!(i instanceof l))throw new Error("Invalid argument error.");this.run=function(){var u=e.inputs(),c=u.length,d=t.Deferred();return t.each(u,function(e,l){var f=t(this),h={instance:f,name:null===a.serializeAttribute?f.prop("name"):f.attr(a.serializeAttribute),type:f.prop("type"),value:f.prop("value"),rules:f.data("validate"),isChecked:f.is(":checked"),isVisible:f.is(":visible"),isEditor:f.hasClass("editor")};return r(h)?h.rules===n||0===h.rules.length?(o(e,c,d),!0):(h.rules=h.rules.split("|"),void t.when(s(u,h)).done(function(){o(e,c,d)}).fail(function(t){i.add(h.name,t),o(e,c,d)})):(o(e,c,d),!0)}),d.promise()}},v=t.extend({redirect:function(e,t){if(!t.redirect)throw new Error("Redirect entry missing.");f.redirect(t.redirect)},reload:function(){f.reload()},fadeOutShowMessage:function(e,t){var n=e.instance().closest(r),i=n.find(s);e.instance().fadeOut(200,function(){i.html(t.message).fadeIn(200)})},fadeOutShowMessageRedirect:function(t,n){var i=t.instance().closest(r),a=i.find(s);t.instance().fadeOut(200,function(){a.html(n.message).fadeIn(200,function(){setTimeout(function(){e.location.href=n.redirect},3e3)})})},fadeOutShowMessageReload:function(t,n){var i=t.instance().closest(r),a=i.find(s);t.instance().fadeOut(200,function(){a.html(n.message).fadeIn(200,function(){setTimeout(function(){e.location.reload(!0)},3e3)})})},fadeOutShowMessageResetFadeIn:function(e,t){var n=e.instance().closest(r),i=n.find(s);e.instance().fadeOut(200,function(){g.endRequest(e),i.html(t.message).fadeIn(200),setTimeout(function(){i.fadeOut(200,function(){e.instance()[0].reset(),e.instance().fadeIn(200)})},3e3)})},callReplaceRemove:function(e,t){f.replace(t),f.remove(t)},ask:function(e,t){if(!this.hasOwnProperty(t.behaviour))throw new Error("Behaviour not specified.");this[t.behaviour](e,t)},run:function(e,t){var n=e.successBehaviour();if(!this.hasOwnProperty(n))throw new Error("Behaviour does not exist.");this[n](e,t)}},a.extendBehaviours),p=function(e){function i(){var e=[];return u.each(function(){var n=t(this).attr(a.serializeAttribute),i=t(this).val();e.push({name:n,value:i})}),e}function r(){if(c.method===n&&(c.method="post"),c.action===n)throw new Error("No action defined.")}var s,o,u=e.find(":input").not(a.ignoreElements),c={method:e.prop("method"),action:e.prop("action"),successBehaviour:e.data("success-behaviour"),inputs:u,data:null===a.serializeAttribute?e.serializeArray():i()};r(),this.instance=function(){return e},this.method=function(){return c.method},this.action=function(){return c.action},this.successBehaviour=function(){return c.successBehaviour},this.inputs=function(){return c.inputs},this.data=function(){return c.data},this.validate=function(){return o=new l,s=new m(this,o),s.run()},this.reset=function(){e.trigger("reset")}},g={clearErrors:function(e){e.instance().find(o+" "+u).removeClass(a.classShow)},displayAlert:function(e){},displayErrors:function(e,n){var i;for(var r in n)if(n.hasOwnProperty(r)){if("alert"==r){this.displayAlert(n[r]);continue}i=t.isArray(n[r])?n[r][0]:n[r],e.instance().find("["+a.dataValidationSegment+'="'+r+'"] ['+a.dataValidationCase+'="'+i+'"]').addClass(a.classShow)}},beginRequest:function(e){return e.instance().data("quiet")?!0:(e.instance().find(c).addClass(a.classHide),void e.instance().find(d).removeClass(a.classHide))},endRequest:function(e){return e.instance().data("quiet")?!0:(e.instance().find(c).removeClass(a.classHide),void e.instance().find(d).addClass(a.classHide))},successBehaviour:function(e,t){v.run(e,t)},disableForm:function(e){this.submitted=e},enableForm:function(){this.submitted=null},endRequestDisplayErrors:function(e,t){this.endRequest(e),this.displayErrors(e,t)},endRequestDisplayErrorsReset:function(e,t){this.endRequestDisplayErrors(e,t),e.reset()},formAction:function(e,n,i,r){var s=this;t.when(e.validate()).done(function(t,r,o){s.beginRequest(e),a.actionMethod(s,e,n,i)}).fail(r)},submit:function(e){var n=this;t(e).on("submit",function(e){e.preventDefault();var i=new p(t(this));n.clearErrors(i),n.formAction(i,function(e){n.successBehaviour(i,e)},function(e,t,a){n.endRequestDisplayErrors(i,e.responseJSON)},function(e){n.endRequestDisplayErrors(i,e)})})},clickSubmit:function(){t(document).on("click",".clickSubmit",function(e){e.preventDefault(),e.stopPropagation();var n=t(this).data("target");t(n).submit()})},init:function(e){this.submit(e),this.clickSubmit()}};return g.init(this)}}(window,window.jQuery);